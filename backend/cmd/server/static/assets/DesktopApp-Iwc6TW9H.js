import{r as a,j as e}from"./index-B16kIOg9.js";import{s as d,a as x,A as T,S as D,T as L}from"./socket-_zAdyrFJ.js";function B({children:m,onLogout:i,sessions:u,currentSessionId:c,onSwitchSession:o,onCreateSession:g,onDeleteSession:f}){const[n,b]=a.useState(!1);return e.jsxs("div",{className:"flex h-screen bg-black text-white",children:[e.jsxs("aside",{className:`${n?"w-12":"w-56"} border-r border-gray-800 transition-all flex flex-col`,children:[e.jsx("div",{className:"p-2 border-b border-gray-800",children:e.jsx("button",{onClick:()=>b(!n),className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors",title:n?"Expand sidebar":"Collapse sidebar",children:n?"☰":"◀"})}),!n&&e.jsxs("div",{className:"flex-1 p-2 overflow-y-auto",children:[e.jsxs("div",{className:"text-xs text-gray-500 uppercase mb-2",children:["Sessions (",u.length,")"]}),e.jsx("div",{className:"space-y-1",children:u.map(r=>e.jsxs("div",{className:`rounded p-2 text-sm cursor-pointer transition-colors group ${r.id===c?"bg-green-900 border border-green-700":"bg-gray-800 hover:bg-gray-700"}`,onClick:()=>r.id!==c&&o(r.id),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:`w-2 h-2 rounded-full flex-shrink-0 ${r.state==="active"?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:"truncate",children:r.title||`Session ${r.id.substring(0,6)}`})]}),r.id!==c&&e.jsx("button",{onClick:p=>{p.stopPropagation(),confirm("Delete this session?")&&f(r.id)},className:"opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-opacity",title:"Delete session",children:"×"})]}),r.id===c&&e.jsx("div",{className:"text-xs text-green-400 mt-1",children:"Current"})]},r.id))}),e.jsxs("button",{onClick:()=>{const r=prompt("Session name (optional):");g(r||void 0)},className:"w-full mt-3 p-2 text-sm bg-gray-800 hover:bg-green-700 rounded transition-colors flex items-center justify-center gap-1",children:[e.jsx("span",{children:"+"}),e.jsx("span",{children:"New Session"})]})]}),n&&e.jsx("div",{className:"flex-1 p-2",children:e.jsx("div",{className:"text-xs text-gray-500 text-center mb-2",children:u.length})}),e.jsx("div",{className:"p-2 border-t border-gray-800 mt-auto",children:e.jsx("button",{onClick:i,className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors text-sm",title:"Logout",children:n?"↪":"Logout"})})]}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"h-10 flex items-center justify-between px-4 bg-gray-900 border-b border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-bold text-green-500",children:"WinTerm Bridge"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Desktop"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:m})]})]})}function W(){const[m,i]=a.useState("loading"),[u,c]=a.useState([]),[o,g]=a.useState(),[f,n]=a.useState(""),[b,r]=a.useState(!1),[p,j]=a.useState(!1),y=a.useRef(!1);a.useEffect(()=>{if(y.current)return;y.current=!0,(async()=>{if(!localStorage.getItem("winterm_token")){i("awaiting_pin");return}try{const{valid:l}=await x.validateToken();if(!l){localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),i("awaiting_pin");return}const{sessions:v}=await x.listSessions();c(v),i("selecting_session")}catch{localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),i("awaiting_pin")}})()},[]),a.useEffect(()=>{const s=d.onOpen(()=>{j(!0),n("")}),t=d.onClose(()=>{j(!1)}),l=d.onError(v=>{n(v),j(!1)});return()=>{s(),t(),l()}},[]);const h=a.useCallback(async s=>{r(!0),n("");try{const{ws_url:t}=await x.attachSession(s);d.connectWithToken(t,s),g(s),localStorage.setItem("winterm_session",s)}catch(t){n(t instanceof Error?t.message:"Failed to connect to session"),i("selecting_session"),g(void 0)}finally{r(!1)}},[]),k=a.useCallback(async s=>{n("");try{const{token:t}=await x.authenticate(s);localStorage.setItem("winterm_token",t);const{sessions:l}=await x.listSessions();c(l),i("selecting_session")}catch(t){n(t instanceof Error?t.message:"Authentication failed")}},[]),C=a.useCallback(async s=>{i("authenticated"),await h(s)},[h]),S=a.useCallback(async s=>{n("");try{const{session:t}=await x.createSession({title:s});c(l=>[...l,t]),i("authenticated"),await h(t.id)}catch(t){n(t instanceof Error?t.message:"Failed to create session")}},[h]),w=a.useCallback(async s=>{if(s===o){n("Cannot delete current session");return}try{await x.deleteSession(s),c(t=>t.filter(l=>l.id!==s))}catch(t){n(t instanceof Error?t.message:"Failed to delete session")}},[o]),_=a.useCallback(async s=>{s!==o&&(d.disconnect(),await h(s))},[o,h]),N=a.useCallback(()=>{d.disconnect(),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),c([]),g(void 0),n(""),i("awaiting_pin")},[]),E=a.useCallback(()=>{d.disconnect(),g(void 0),i("selecting_session")},[]);return a.useEffect(()=>{if(m!=="authenticated"||!o)return;const t=setInterval(async()=>{try{const{sessions:l}=await x.listSessions();c(l)}catch{}},3e4);return()=>clearInterval(t)},[m,o]),m==="loading"?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Loading..."})]})}):m==="awaiting_pin"?e.jsx(T,{onSubmit:k,error:f}):m==="selecting_session"?e.jsx(D,{sessions:u,onSelect:C,onCreate:S,onDelete:w,onLogout:N}):b?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Connecting to session..."})]})}):f&&!o?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-red-500 mb-4",children:f}),e.jsx("button",{onClick:E,className:"text-gray-400 hover:text-gray-300 underline",children:"Back to Sessions"})]})}):e.jsx(B,{onLogout:N,sessions:u,currentSessionId:o,onSwitchSession:_,onCreateSession:S,onDeleteSession:w,children:o&&e.jsxs("div",{className:"w-full h-full relative",children:[e.jsx(L,{socket:d,fontSize:14}),!p&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-400 mb-4",children:"Disconnected"}),e.jsx("button",{onClick:()=>h(o),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Reconnect"})]})})]})})}export{W as default};
