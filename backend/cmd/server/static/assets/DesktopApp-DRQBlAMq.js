import{r,j as e}from"./index-DXUfe_HT.js";import{a as m,s as u,A,S as E,T}from"./api-U0u3bUPW.js";function L({children:b,onFontSizeChange:j,onLogout:g,fontSize:i,sessions:l,currentSessionId:o,onSwitchSession:y,onCreateSession:x,onDeleteSession:d}){const[c,p]=r.useState(!1);return e.jsxs("div",{className:"flex h-screen bg-black text-white",children:[e.jsxs("aside",{className:`${c?"w-12":"w-56"} border-r border-gray-800 transition-all flex flex-col`,children:[e.jsx("div",{className:"p-2 border-b border-gray-800",children:e.jsx("button",{onClick:()=>p(!c),className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors",title:c?"Expand sidebar":"Collapse sidebar",children:c?"☰":"◀"})}),!c&&e.jsxs("div",{className:"flex-1 p-2 overflow-y-auto",children:[e.jsxs("div",{className:"text-xs text-gray-500 uppercase mb-2",children:["Sessions (",l.length,")"]}),e.jsx("div",{className:"space-y-1",children:l.map(s=>e.jsxs("div",{className:`rounded p-2 text-sm cursor-pointer transition-colors group ${s.id===o?"bg-green-900 border border-green-700":"bg-gray-800 hover:bg-gray-700"}`,onClick:()=>s.id!==o&&y(s.id),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:`w-2 h-2 rounded-full flex-shrink-0 ${s.state==="active"?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:"truncate",children:s.title||`Session ${s.id.substring(0,6)}`})]}),s.id!==o&&e.jsx("button",{onClick:f=>{f.stopPropagation(),confirm("Delete this session?")&&d(s.id)},className:"opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-opacity",title:"Delete session",children:"×"})]}),s.id===o&&e.jsx("div",{className:"text-xs text-green-400 mt-1",children:"Current"})]},s.id))}),e.jsxs("button",{onClick:()=>{const s=prompt("Session name (optional):");x(s||void 0)},className:"w-full mt-3 p-2 text-sm bg-gray-800 hover:bg-green-700 rounded transition-colors flex items-center justify-center gap-1",children:[e.jsx("span",{children:"+"}),e.jsx("span",{children:"New Session"})]})]}),c&&e.jsx("div",{className:"flex-1 p-2",children:e.jsx("div",{className:"text-xs text-gray-500 text-center mb-2",children:l.length})}),e.jsx("div",{className:"p-2 border-t border-gray-800 mt-auto",children:e.jsx("button",{onClick:g,className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors text-sm",title:"Logout",children:c?"↪":"Logout"})})]}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsxs("header",{className:"h-10 flex items-center justify-between px-4 bg-gray-900 border-b border-gray-800",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-bold text-green-500",children:"WinTerm Bridge"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Desktop"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>j(Math.max(8,i-1)),className:"px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 rounded",title:"Decrease font size",children:"A-"}),e.jsx("span",{className:"text-xs text-gray-400 w-8 text-center",children:i}),e.jsx("button",{onClick:()=>j(Math.min(32,i+1)),className:"px-2 py-1 text-xs bg-gray-800 hover:bg-gray-700 rounded",title:"Increase font size",children:"A+"})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:b}),e.jsxs("footer",{className:"h-6 flex items-center px-4 bg-gray-900 border-t border-gray-800 text-xs text-gray-500",children:[e.jsx("span",{children:"Ready"}),e.jsxs("span",{className:"ml-auto",children:["Font: ",i,"px"]})]})]})]})}function I(){const[b,j]=r.useState(14),[g,i]=r.useState("disconnected"),[l,o]=r.useState("loading"),[y,x]=r.useState([]),[d,c]=r.useState(),[p,s]=r.useState(""),f=r.useRef(!1),v=r.useRef(!1);r.useEffect(()=>{if(v.current)return;v.current=!0,(async()=>{if(!localStorage.getItem("winterm_token")){o("awaiting_pin");return}try{const{valid:a}=await m.validateToken();if(!a){localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),o("awaiting_pin");return}const{sessions:k}=await m.listSessions();x(k),o("selecting_session")}catch(a){console.error("[DesktopApp] Init error:",a),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),o("awaiting_pin")}})()},[]);const h=r.useCallback(async n=>{if(f.current){console.log("[DesktopApp] Already connecting, skipping");return}f.current=!0,i("connecting"),s("");try{const{attachment_token:t}=await m.attachSession(n);u.connectWithToken(t,n),c(n),localStorage.setItem("winterm_session",n)}catch(t){console.error("[DesktopApp] Failed to connect to session:",t),s(t instanceof Error?t.message:"Failed to connect to session"),i("disconnected"),o("selecting_session"),c(void 0)}finally{f.current=!1}},[]);r.useEffect(()=>{const n=u.onOpen(()=>{console.log("[DesktopApp] Socket opened"),i("connected"),s("")}),t=u.onClose(()=>{console.log("[DesktopApp] Socket closed"),i("disconnected")}),a=u.onError(k=>{console.error("[DesktopApp] Socket error:",k),s(k),i("disconnected")});return()=>{n(),t(),a()}},[]);const C=r.useCallback(async n=>{s("");try{const{token:t}=await m.authenticate(n);localStorage.setItem("winterm_token",t);const{sessions:a}=await m.listSessions();x(a),o("selecting_session")}catch(t){console.error("[DesktopApp] Auth error:",t),s(t instanceof Error?t.message:"Authentication failed")}},[]),D=r.useCallback(async n=>{o("authenticated"),await h(n)},[h]),S=r.useCallback(async n=>{s("");try{const{session:t}=await m.createSession(n);x(a=>[...a,t]),o("authenticated"),await h(t.id)}catch(t){console.error("[DesktopApp] Create session error:",t),s(t instanceof Error?t.message:"Failed to create session")}},[h]),w=r.useCallback(async n=>{if(n===d){s("Cannot delete current session");return}try{await m.deleteSession(n),x(t=>t.filter(a=>a.id!==n))}catch(t){console.error("[DesktopApp] Delete session error:",t),s(t instanceof Error?t.message:"Failed to delete session")}},[d]),_=r.useCallback(async n=>{n!==d&&await h(n)},[d,h]),N=r.useCallback(()=>{console.log("[DesktopApp] Logging out"),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),u.disconnect(),x([]),c(void 0),i("disconnected"),s(""),o("awaiting_pin")},[]);return r.useEffect(()=>{if(l!=="authenticated"||g!=="connected")return;const t=setInterval(async()=>{try{const{sessions:a}=await m.listSessions();x(a)}catch(a){console.error("[DesktopApp] Failed to refresh sessions:",a)}},3e4);return()=>clearInterval(t)},[l,g]),l==="loading"?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Loading..."})]})}):l==="awaiting_pin"?e.jsx(A,{onSubmit:C,error:p}):l==="selecting_session"?e.jsx(E,{sessions:y,onSelect:D,onCreate:S,onDelete:w,onLogout:N}):g==="connecting"?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Connecting to session..."})]})}):g==="disconnected"&&d?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Connection lost"}),p&&e.jsx("p",{className:"text-red-500 mb-4",children:p}),e.jsx("button",{onClick:()=>h(d),className:"text-green-500 hover:text-green-400 underline mr-4",children:"Reconnect"}),e.jsx("button",{onClick:()=>{o("selecting_session"),c(void 0),i("disconnected")},className:"text-gray-400 hover:text-gray-300 underline",children:"Back to Sessions"})]})}):g==="disconnected"&&!d?(l==="authenticated"&&o("selecting_session"),null):e.jsx(L,{onFontSizeChange:j,onLogout:N,fontSize:b,sessions:y,currentSessionId:d,onSwitchSession:_,onCreateSession:S,onDeleteSession:w,children:e.jsx(T,{socket:u,fontSize:b})})}export{I as default};
