import{r as l,j as t}from"./index-DXUfe_HT.js";import{u as L,a as y,s as p,A as V,S as R,T as I}from"./api-U0u3bUPW.js";function W(){const[s,o]=l.useState({width:window.innerWidth,height:window.innerHeight,offsetLeft:0,offsetTop:0,keyboardVisible:!1});return l.useEffect(()=>{var i,a;const e=()=>{if(window.visualViewport){const d=window.visualViewport,f=d.height<window.innerHeight*.75;o({width:d.width,height:d.height,offsetLeft:d.offsetLeft,offsetTop:d.offsetTop,keyboardVisible:f})}};return e(),(i=window.visualViewport)==null||i.addEventListener("resize",e),(a=window.visualViewport)==null||a.addEventListener("scroll",e),()=>{var d,f;(d=window.visualViewport)==null||d.removeEventListener("resize",e),(f=window.visualViewport)==null||f.removeEventListener("scroll",e)}},[]),s}function Y({children:s,viewportHeight:o,keyboardVisible:e,onLogout:i}){return t.jsxs("div",{className:"fixed inset-0 flex flex-col bg-black",style:{height:`${o}px`},children:[!e&&t.jsxs("header",{className:"h-10 flex items-center justify-between px-4 bg-gray-900 border-b border-gray-800 shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm font-bold text-green-500",children:"WinTerm"}),t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"})]}),t.jsx("button",{onClick:i,className:"text-xs text-gray-400 hover:text-white px-2 py-1",children:"Logout"})]}),t.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:s})]})}function N(s){var o,e,i="";if(typeof s=="string"||typeof s=="number")i+=s;else if(typeof s=="object")if(Array.isArray(s)){var a=s.length;for(o=0;o<a;o++)s[o]&&(e=N(s[o]))&&(i&&(i+=" "),i+=e)}else for(e in s)s[e]&&(i&&(i+=" "),i+=e);return i}function F(){for(var s,o,e=0,i="",a=arguments.length;e<a;e++)(s=arguments[e])&&(o=N(s))&&(i&&(i+=" "),i+=o);return i}const C=({label:s,state:o,onClick:e})=>{const i=()=>{switch(o){case"latched":return`${s} (Active)`;case"locked":return`${s} (Locked)`;default:return s}};return t.jsx("button",{onClick:a=>{a.preventDefault(),e()},"aria-label":i(),"aria-pressed":o!=="idle",className:F("flex-1 px-2 py-3 text-sm font-mono font-bold transition-colors select-none min-h-[44px]",o==="idle"&&"bg-gray-800 text-gray-400 active:bg-gray-700",o==="latched"&&"bg-green-700 text-white",o==="locked"&&"bg-green-600 text-white border-b-2 border-white"),children:s})},j=({label:s,onClick:o})=>t.jsx("button",{onClick:e=>{e.preventDefault(),o()},className:"flex-1 px-2 py-3 text-sm font-mono font-bold bg-gray-800 text-gray-300 active:bg-gray-700 border-l border-gray-700 min-h-[44px]",children:s}),H=({onSendKey:s})=>{const{modifiers:o,toggleModifier:e}=L();return t.jsxs("div",{className:"flex w-full overflow-x-auto bg-gray-900 border-t border-gray-700 pb-safe shrink-0",children:[t.jsx(C,{label:"CTRL",modKey:"ctrl",state:o.ctrl,onClick:()=>e("ctrl")}),t.jsx(C,{label:"ALT",modKey:"alt",state:o.alt,onClick:()=>e("alt")}),t.jsx(C,{label:"SHIFT",modKey:"shift",state:o.shift,onClick:()=>e("shift")}),t.jsx(j,{label:"TAB",onClick:()=>s("	")}),t.jsx(j,{label:"ESC",onClick:()=>s("\x1B")}),t.jsx(j,{label:"▲",onClick:()=>s("\x1B[A")}),t.jsx(j,{label:"▼",onClick:()=>s("\x1B[B")})]})};function z(s,o,e){const i=o.querySelector(".xterm-helper-textarea");if(!i)return;let a=!1,d="";const f=n=>{const{modifiers:x,consumeModifiers:m}=L.getState();let u=n;if(x.ctrl!=="idle"&&n.length===1){const b=n.charCodeAt(0);b>=97&&b<=122?u=String.fromCharCode(b-96):b>=65&&b<=90&&(u=String.fromCharCode(b-64))}x.alt!=="idle"&&(u=`\x1B${u}`),e.send(u),m()};i.addEventListener("compositionstart",()=>{a=!0}),i.addEventListener("compositionend",n=>{a=!1,d=n.data||"",n.data&&f(n.data)}),i.addEventListener("beforeinput",n=>{if(!a){if(n.data===d&&d!==""){d="";return}switch(n.inputType){case"insertText":n.data&&(f(n.data),n.preventDefault());break;case"deleteContentBackward":e.send(""),n.preventDefault();break;case"deleteContentForward":e.send("\x1B[3~"),n.preventDefault();break;case"insertLineBreak":e.send("\r"),n.preventDefault();break}}});let g=0,w=0,v=!1;o.addEventListener("touchstart",n=>{g=n.touches[0].clientY,w=Date.now(),v=!1},{passive:!0}),o.addEventListener("touchmove",n=>{const x=n.touches[0].clientY,m=g-x;if(Math.abs(m)>10){v=!0;const u=Math.floor(Math.abs(m)/20);u>0&&(m>0?s.scrollLines(-u):s.scrollLines(u),g=x)}},{passive:!0}),o.addEventListener("touchend",n=>{const x=n.changedTouches[0].clientY,m=Date.now()-w,u=Math.abs(x-g);!v&&m<300&&u<10&&(n.preventDefault(),s.focus(),i.focus())})}function O(){const[s]=l.useState(16),[o,e]=l.useState("disconnected"),[i,a]=l.useState("loading"),[d,f]=l.useState([]),[g,w]=l.useState(),[v,n]=l.useState(""),x=W(),{consumeModifiers:m}=L(),u=l.useRef(!1),b=l.useRef(!1);l.useEffect(()=>{if(b.current)return;b.current=!0,(async()=>{if(!localStorage.getItem("winterm_token")){a("awaiting_pin");return}try{const{valid:h}=await y.validateToken();if(!h){localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),a("awaiting_pin");return}const{sessions:S}=await y.listSessions();f(S),a("selecting_session")}catch(h){console.error("[MobileApp] Init error:",h),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),a("awaiting_pin")}})()},[]);const k=l.useCallback(async c=>{if(u.current){console.log("[MobileApp] Already connecting, skipping");return}u.current=!0,e("connecting"),n("");try{const{attachment_token:r}=await y.attachSession(c);p.connectWithToken(r,c),w(c),localStorage.setItem("winterm_session",c)}catch(r){console.error("[MobileApp] Failed to connect to session:",r),n(r instanceof Error?r.message:"Failed to connect to session"),e("disconnected"),a("selecting_session"),w(void 0)}finally{u.current=!1}},[]);l.useEffect(()=>{const c=p.onOpen(()=>{console.log("[MobileApp] Socket opened"),e("connected"),n("")}),r=p.onClose(()=>{console.log("[MobileApp] Socket closed"),e("disconnected")}),h=p.onError(S=>{console.error("[MobileApp] Socket error:",S),n(S),e("disconnected")});return()=>{c(),r(),h()}},[]);const E=l.useCallback(async c=>{n("");try{const{token:r}=await y.authenticate(c);localStorage.setItem("winterm_token",r);const{sessions:h}=await y.listSessions();f(h),a("selecting_session")}catch(r){console.error("[MobileApp] Auth error:",r),n(r instanceof Error?r.message:"Authentication failed")}},[]),T=l.useCallback(async c=>{a("authenticated"),await k(c)},[k]),M=l.useCallback(async c=>{n("");try{const{session:r}=await y.createSession(c);f(h=>[...h,r]),a("authenticated"),await k(r.id)}catch(r){console.error("[MobileApp] Create session error:",r),n(r instanceof Error?r.message:"Failed to create session")}},[k]),_=l.useCallback(async c=>{if(c===g){n("Cannot delete current session");return}try{await y.deleteSession(c),f(r=>r.filter(h=>h.id!==c))}catch(r){console.error("[MobileApp] Delete session error:",r),n(r instanceof Error?r.message:"Failed to delete session")}},[g]),A=l.useCallback(()=>{console.log("[MobileApp] Logging out"),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),p.disconnect(),f([]),w(void 0),e("disconnected"),n(""),a("awaiting_pin")},[]),D=l.useCallback((c,r)=>{z(c,r,p)},[]),B=l.useCallback(c=>{p.send(c),m()},[m]);return i==="loading"?t.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:t.jsxs("div",{className:"text-center p-8",children:[t.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),t.jsx("p",{className:"text-gray-400",children:"Loading..."})]})}):i==="awaiting_pin"?t.jsx(V,{onSubmit:E,error:v}):i==="selecting_session"?t.jsx(R,{sessions:d,onSelect:T,onCreate:M,onDelete:_,onLogout:A}):o==="connecting"?t.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:t.jsxs("div",{className:"text-center p-8",children:[t.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),t.jsx("p",{className:"text-gray-400",children:"Connecting to session..."})]})}):o==="disconnected"&&g?t.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:t.jsxs("div",{className:"text-center p-8",children:[t.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),t.jsx("p",{className:"text-gray-400 mb-4",children:"Connection lost"}),v&&t.jsx("p",{className:"text-red-500 mb-4",children:v}),t.jsx("button",{onClick:()=>k(g),className:"text-green-500 hover:text-green-400 underline mr-4",children:"Reconnect"}),t.jsx("button",{onClick:()=>{a("selecting_session"),w(void 0),e("disconnected")},className:"text-gray-400 hover:text-gray-300 underline",children:"Back to Sessions"})]})}):o==="disconnected"&&!g?(i==="authenticated"&&a("selecting_session"),null):t.jsxs(Y,{viewportHeight:x.height,keyboardVisible:x.keyboardVisible,onLogout:A,children:[t.jsx("div",{className:"flex-1 overflow-hidden",children:t.jsx(I,{socket:p,fontSize:s,onTerminalReady:D})}),t.jsx(H,{onSendKey:B})]})}export{O as default};
