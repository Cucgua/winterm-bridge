import{j as e,r as n}from"./index-ujZ2fpNt.js";import{a as m,A as C,S as _}from"./api-DVUaMRt_.js";const D=({sessionId:d,className:i})=>{const x=`/ttyd/${d}/`;return e.jsx("iframe",{src:x,className:i||"w-full h-full border-0",allow:"clipboard-read; clipboard-write",title:"Terminal"})};function A({children:d,onLogout:i,sessions:x,currentSessionId:c,onSwitchSession:l,onCreateSession:h,onDeleteSession:g}){const[r,f]=n.useState(!1);return e.jsxs("div",{className:"flex h-screen bg-black text-white",children:[e.jsxs("aside",{className:`${r?"w-12":"w-56"} border-r border-gray-800 transition-all flex flex-col`,children:[e.jsx("div",{className:"p-2 border-b border-gray-800",children:e.jsx("button",{onClick:()=>f(!r),className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors",title:r?"Expand sidebar":"Collapse sidebar",children:r?"☰":"◀"})}),!r&&e.jsxs("div",{className:"flex-1 p-2 overflow-y-auto",children:[e.jsxs("div",{className:"text-xs text-gray-500 uppercase mb-2",children:["Sessions (",x.length,")"]}),e.jsx("div",{className:"space-y-1",children:x.map(a=>e.jsxs("div",{className:`rounded p-2 text-sm cursor-pointer transition-colors group ${a.id===c?"bg-green-900 border border-green-700":"bg-gray-800 hover:bg-gray-700"}`,onClick:()=>a.id!==c&&l(a.id),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:`w-2 h-2 rounded-full flex-shrink-0 ${a.state==="active"?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:"truncate",children:a.title||`Session ${a.id.substring(0,6)}`})]}),a.id!==c&&e.jsx("button",{onClick:p=>{p.stopPropagation(),confirm("Delete this session?")&&g(a.id)},className:"opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-opacity",title:"Delete session",children:"×"})]}),a.id===c&&e.jsx("div",{className:"text-xs text-green-400 mt-1",children:"Current"})]},a.id))}),e.jsxs("button",{onClick:()=>{const a=prompt("Session name (optional):");h(a||void 0)},className:"w-full mt-3 p-2 text-sm bg-gray-800 hover:bg-green-700 rounded transition-colors flex items-center justify-center gap-1",children:[e.jsx("span",{children:"+"}),e.jsx("span",{children:"New Session"})]})]}),r&&e.jsx("div",{className:"flex-1 p-2",children:e.jsx("div",{className:"text-xs text-gray-500 text-center mb-2",children:x.length})}),e.jsx("div",{className:"p-2 border-t border-gray-800 mt-auto",children:e.jsx("button",{onClick:i,className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors text-sm",title:"Logout",children:r?"↪":"Logout"})})]}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"h-10 flex items-center justify-between px-4 bg-gray-900 border-b border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-bold text-green-500",children:"WinTerm Bridge"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Desktop"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:d})]})]})}function I(){const[d,i]=n.useState("loading"),[x,c]=n.useState([]),[l,h]=n.useState(),[g,r]=n.useState(""),[f,a]=n.useState(!1),p=n.useRef(!1);n.useEffect(()=>{if(p.current)return;p.current=!0,(async()=>{if(!localStorage.getItem("winterm_token")){i("awaiting_pin");return}try{const{valid:o}=await m.validateToken();if(!o){localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),i("awaiting_pin");return}const{sessions:k}=await m.listSessions();c(k),i("selecting_session")}catch(o){console.error("[DesktopApp] Init error:",o),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),i("awaiting_pin")}})()},[]);const u=n.useCallback(async s=>{a(!0),r("");try{await m.attachSession(s),h(s),localStorage.setItem("winterm_session",s)}catch(t){console.error("[DesktopApp] Failed to attach to session:",t),r(t instanceof Error?t.message:"Failed to connect to session"),i("selecting_session"),h(void 0)}finally{a(!1)}},[]),w=n.useCallback(async s=>{r("");try{const{token:t}=await m.authenticate(s);localStorage.setItem("winterm_token",t);const{sessions:o}=await m.listSessions();c(o),i("selecting_session")}catch(t){console.error("[DesktopApp] Auth error:",t),r(t instanceof Error?t.message:"Authentication failed")}},[]),v=n.useCallback(async s=>{i("authenticated"),await u(s)},[u]),b=n.useCallback(async s=>{r("");try{const{session:t}=await m.createSession({title:s});c(o=>[...o,t]),i("authenticated"),await u(t.id)}catch(t){console.error("[DesktopApp] Create session error:",t),r(t instanceof Error?t.message:"Failed to create session")}},[u]),j=n.useCallback(async s=>{if(s===l){r("Cannot delete current session");return}try{await m.deleteSession(s),c(t=>t.filter(o=>o.id!==s))}catch(t){console.error("[DesktopApp] Delete session error:",t),r(t instanceof Error?t.message:"Failed to delete session")}},[l]),S=n.useCallback(async s=>{s!==l&&await u(s)},[l,u]),y=n.useCallback(()=>{localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),c([]),h(void 0),r(""),i("awaiting_pin")},[]),N=n.useCallback(()=>{h(void 0),i("selecting_session")},[]);return n.useEffect(()=>{if(d!=="authenticated"||!l)return;const t=setInterval(async()=>{try{const{sessions:o}=await m.listSessions();c(o)}catch(o){console.error("[DesktopApp] Failed to refresh sessions:",o)}},3e4);return()=>clearInterval(t)},[d,l]),d==="loading"?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Loading..."})]})}):d==="awaiting_pin"?e.jsx(C,{onSubmit:w,error:g}):d==="selecting_session"?e.jsx(_,{sessions:x,onSelect:v,onCreate:b,onDelete:j,onLogout:y}):f?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Connecting to session..."})]})}):g&&!l?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-red-500 mb-4",children:g}),e.jsx("button",{onClick:N,className:"text-gray-400 hover:text-gray-300 underline",children:"Back to Sessions"})]})}):e.jsx(A,{onLogout:y,sessions:x,currentSessionId:l,onSwitchSession:S,onCreateSession:b,onDeleteSession:j,children:l&&e.jsx(D,{sessionId:l,className:"w-full h-full"})})}export{I as default};
