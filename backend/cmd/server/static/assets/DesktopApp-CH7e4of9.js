import{r as a,j as e}from"./index-DsokOmcQ.js";import{s as m,a as d,A as W,S as A,T as F}from"./socket-Bo1tFOFg.js";function R({children:h,onLogout:l,sessions:g,currentSessionId:o,onSwitchSession:c,onCreateSession:u,onDeleteSession:f}){const[n,p]=a.useState(!1);return e.jsxs("div",{className:"flex h-screen bg-black text-white",children:[e.jsxs("aside",{className:`${n?"w-12":"w-56"} border-r border-gray-800 transition-all flex flex-col`,children:[e.jsx("div",{className:"p-2 border-b border-gray-800",children:e.jsx("button",{onClick:()=>p(!n),className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors",title:n?"Expand sidebar":"Collapse sidebar",children:n?"☰":"◀"})}),!n&&e.jsxs("div",{className:"flex-1 p-2 overflow-y-auto",children:[e.jsxs("div",{className:"text-xs text-gray-500 uppercase mb-2",children:["Sessions (",g.length,")"]}),e.jsx("div",{className:"space-y-1",children:g.map(i=>e.jsxs("div",{className:`rounded p-2 text-sm cursor-pointer transition-colors group ${i.id===o?"bg-green-900 border border-green-700":"bg-gray-800 hover:bg-gray-700"}`,onClick:()=>i.id!==o&&c(i.id),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:`w-2 h-2 rounded-full flex-shrink-0 ${i.state==="active"?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:"truncate",children:i.title||`Session ${i.id.substring(0,6)}`})]}),i.id!==o&&e.jsx("button",{onClick:j=>{j.stopPropagation(),confirm("Delete this session?")&&f(i.id)},className:"opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 p-1 transition-opacity",title:"Delete session",children:"×"})]}),i.id===o&&e.jsx("div",{className:"text-xs text-green-400 mt-1",children:"Current"})]},i.id))}),e.jsxs("button",{onClick:()=>{const i=prompt("Session name (optional):");u(i||void 0)},className:"w-full mt-3 p-2 text-sm bg-gray-800 hover:bg-green-700 rounded transition-colors flex items-center justify-center gap-1",children:[e.jsx("span",{children:"+"}),e.jsx("span",{children:"New Session"})]})]}),n&&e.jsx("div",{className:"flex-1 p-2",children:e.jsx("div",{className:"text-xs text-gray-500 text-center mb-2",children:g.length})}),e.jsx("div",{className:"p-2 border-t border-gray-800 mt-auto",children:e.jsx("button",{onClick:l,className:"w-full p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors text-sm",title:"Logout",children:n?"↪":"Logout"})})]}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("header",{className:"h-10 flex items-center justify-between px-4 bg-gray-900 border-b border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-bold text-green-500",children:"WinTerm Bridge"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Desktop"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:h})]})]})}function I(){const[h,l]=a.useState("loading"),[g,o]=a.useState([]),[c,u]=a.useState(),[f,n]=a.useState(""),[p,i]=a.useState(!1),[j,S]=a.useState(!1),[y,v]=a.useState(!1),N=a.useRef(!1);a.useEffect(()=>{if(N.current)return;N.current=!0,(async()=>{if(!localStorage.getItem("winterm_token")){l("awaiting_pin");return}try{const{valid:r}=await d.validateToken();if(!r){localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),l("awaiting_pin");return}const{sessions:x}=await d.listSessions();o(x),l("selecting_session")}catch{localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),l("awaiting_pin")}})()},[]),a.useEffect(()=>{const s=m.onOpen(()=>{S(!0),n("")}),t=m.onClose(()=>{S(!1)}),r=m.onError(x=>{n(x),S(!1)});return()=>{s(),t(),r()}},[]);const b=a.useCallback(async s=>{i(!0),n("");try{const{ws_url:t}=await d.attachSession(s);m.connectWithToken(t,s),u(s),localStorage.setItem("winterm_session",s)}catch(t){n(t instanceof Error?t.message:"Failed to connect to session"),l("selecting_session"),u(void 0)}finally{i(!1)}},[]),E=a.useCallback(async s=>{n("");try{const{token:t}=await d.authenticate(s);localStorage.setItem("winterm_token",t);const{sessions:r}=await d.listSessions();o(r),l("selecting_session")}catch(t){n(t instanceof Error?t.message:"Authentication failed")}},[]),T=a.useCallback(async s=>{l("authenticated"),await b(s)},[b]),k=a.useCallback(async s=>{n("");try{const{session:t}=await d.createSession({title:s});o(r=>[...r,t]),l("authenticated"),await b(t.id)}catch(t){n(t instanceof Error?t.message:"Failed to create session")}},[b]),C=a.useCallback(async s=>{if(s===c){n("Cannot delete current session");return}try{await d.deleteSession(s),o(t=>t.filter(r=>r.id!==s))}catch(t){n(t instanceof Error?t.message:"Failed to delete session")}},[c]),D=a.useCallback(async(s,t)=>{o(r=>r.map(x=>x.id===s?{...x,is_persistent:!t}:x));try{t?await d.unpersistSession(s):await d.persistSession(s)}catch(r){o(x=>x.map(w=>w.id===s?{...w,is_persistent:t}:w)),n(r instanceof Error?r.message:"Failed to update persistence")}},[]),L=a.useCallback(async s=>{if(s!==c){v(!0),n(""),m.disconnect();try{const{ws_url:t}=await d.attachSession(s);m.connectWithToken(t,s),u(s),localStorage.setItem("winterm_session",s)}catch(t){n(t instanceof Error?t.message:"Failed to connect to session")}finally{v(!1)}}},[c]),_=a.useCallback(()=>{m.disconnect(),localStorage.removeItem("winterm_token"),localStorage.removeItem("winterm_session"),o([]),u(void 0),n(""),l("awaiting_pin")},[]),B=a.useCallback(()=>{m.disconnect(),u(void 0),l("selecting_session")},[]);return a.useEffect(()=>{if(h!=="authenticated"||!c)return;const t=setInterval(async()=>{try{const{sessions:r}=await d.listSessions();o(r)}catch{}},3e4);return()=>clearInterval(t)},[h,c]),h==="loading"?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Loading..."})]})}):h==="awaiting_pin"?e.jsx(W,{onSubmit:E,error:f}):h==="selecting_session"?e.jsx(A,{sessions:g,onSelect:T,onCreate:k,onDelete:C,onLogout:_,onTogglePersist:D}):p&&!c?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-gray-400",children:"Connecting to session..."})]})}):f&&!c?e.jsx("div",{className:"flex items-center justify-center h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"WinTerm Bridge"}),e.jsx("p",{className:"text-red-500 mb-4",children:f}),e.jsx("button",{onClick:B,className:"text-gray-400 hover:text-gray-300 underline",children:"Back to Sessions"})]})}):e.jsx(R,{onLogout:_,sessions:g,currentSessionId:c,onSwitchSession:L,onCreateSession:k,onDeleteSession:C,children:c&&e.jsxs("div",{className:"w-full h-full relative",children:[e.jsx(F,{socket:m,fontSize:14},c),y&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/90",children:e.jsx("p",{className:"text-gray-400",children:"Switching session..."})}),!y&&!j&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/80",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-400 mb-4",children:"Disconnected"}),e.jsx("button",{onClick:()=>b(c),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Reconnect"})]})})]})})}export{I as default};
